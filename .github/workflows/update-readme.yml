name: Update README badges

on:
  workflow_dispatch:
  schedule:
    # run daily at 04:00 UTC
    - cron: "0 4 * * *"

jobs:
  update-readme:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Update badges and timestamp in README
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // 1) Fetch profile data
            const { data: user } = await github.rest.users.getByUsername({ username: owner });
            const followers = user.followers;
            const publicRepos = user.public_repos;
            const updatedAt = new Date().toISOString().replace(/T/, " ").replace(/\..+/, " UTC");

            // 2) Load README.md
            const readmePath = path.join(process.cwd(), "README.md");
            let readme = fs.readFileSync(readmePath, "utf8");

            // 3) Replace follower + repo badges dynamically
            readme = readme.replace(
              /!\[GitHub followers\]\([^)]+\)/,
              `![GitHub followers](https://img.shields.io/badge/Followers-${followers}-blue?style=flat-square)`
            );

            readme = readme.replace(
              /!\[Public repos\]\([^)]+\)/,
              `![Public repos](https://img.shields.io/badge/Public%20repos-${publicRepos}-brightgreen?style=flat-square)`
            );

            // 4) Ensure a "Last updated" footer exists
            if (readme.includes("Last updated:")) {
              readme = readme.replace(/Last updated:.*/, `Last updated: ${updatedAt}`);
            } else {
              readme += `\n\n---\n_Last updated: ${updatedAt}_\n`;
            }

            // 5) Commit back if changed
            const oldContent = (
              await github.rest.repos.getContent({
                owner,
                repo,
                path: "README.md",
              })
            ).data;

            const oldDecoded = Buffer.from(oldContent.content, "base64").toString("utf8");

            if (oldDecoded === readme) {
              core.info("No README changes detected.");
              return;
            }

            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path: "README.md",
              message: "chore: update README badges and timestamp",
              content: Buffer.from(readme, "utf8").toString("base64"),
              sha: oldContent.sha,
            });

            core.info("README.md updated successfully.");
