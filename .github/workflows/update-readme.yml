name: Update README projects list

on:
  workflow_dispatch:
  schedule:
    # update once a day – change if you want
    - cron: "0 4 * * *"

jobs:
  update-readme:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Update projects list in README
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            const owner = context.repo.owner;

            // 1) Fetch all public repos for this user
            const allRepos = await github.paginate(
              github.rest.repos.listForUser,
              {
                username: owner,
                per_page: 100,
                sort: "full_name",
                direction: "asc",
              }
            );

            // Filter out forks and maybe other stuff you don't want
            const repos = allRepos.filter(r => !r.fork);

            // 2) Build markdown list
            const lines = repos.map(r => {
              const name = r.name;
              const url = r.html_url;
              const desc = (r.description || "").replace(/\r?\n/g, " ").trim();
              const descPart = desc ? ` — ${desc}` : "";
              return `- [${name}](${url})${descPart}`;
            });

            const block = [
              "<!-- PROJECTS-LIST:START -->",
              ...lines,
              "<!-- PROJECTS-LIST:END -->",
              ""
            ].join("\n");

            // 3) Read README and replace block
            const readmePath = path.join(process.cwd(), "README.md");
            let readme = fs.readFileSync(readmePath, "utf8");

            const startTag = "<!-- PROJECTS-LIST:START -->";
            const endTag = "<!-- PROJECTS-LIST:END -->";

            const startIndex = readme.indexOf(startTag);
            const endIndex = readme.indexOf(endTag);

            if (startIndex === -1 || endIndex === -1) {
              core.setFailed("PROJECTS-LIST markers not found in README.md");
              return;
            }

            const before = readme.slice(0, startIndex);
            const after = readme.slice(endIndex + endTag.length);
            const nextReadme = before + block + after;

            if (nextReadme === readme) {
              core.info("README.md already up to date, no changes.");
              return;
            }

            fs.writeFileSync(readmePath, nextReadme, "utf8");

            // 4) Commit
            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: "README.md",
              message: "chore: auto-update projects list in README",
              content: Buffer.from(nextReadme, "utf8").toString("base64"),
              sha: (
                await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: "README.md",
                })
              ).data.sha,
            });
